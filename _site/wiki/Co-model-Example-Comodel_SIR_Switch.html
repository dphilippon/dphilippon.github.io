
    <!doctype html><html lang="en"><head><meta charset="utf-8"><title>Comodel SIR Switch</title></head>
    <body>
    <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/w3.css">
<link rel="stylesheet" href="/css/font-awesome.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="//connect.facebook.net/en_US/all.js"></script>
<script src="/js/linkify.min.js"></script>
<script src="/js/linkify-jquery.min.js"></script>

    <div class="w3-bar w3-white w3-hide-small">
      <a href="/" class="w3-bar-item w3-button"><img src="/images/icon_gama_50.png"></a>
      <a href="/wiki/Home" class="w3-bar-item w3-button w3-text-blue">Documentation</a>
      <a href="/wiki/Tutorials" class="w3-bar-item w3-button w3-text-blue">Tutorials</a>
      <a href="/download" class="w3-bar-item w3-button w3-text-blue">Download</a>
      <a href="/news" class="w3-bar-item w3-button w3-text-blue">News</a>
      <a href="/contribute" class="w3-bar-item w3-button w3-text-blue">Contribute</a>
    </div>

    <div class="w3-row-padding w3-padding-64 w3-container">
        <div>
             <div class="w3-quarter" style="width:260px">
		<nav class="w3-bar-block w3-collapse w3-large w3-theme-l5 w3-animate-left w3-small"  style="z-index:3;margin-left:10px" id="mySidebar">
                    <div class="w3-medium w3-text-blue" style="font-weight:bold"><div>
<a href='/wiki/Tutorials'>Tutorials
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/LearnGAMLStepByStep'>Learn GAML Step by Step
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/Introduction'>Introduction
</a><br/>
<a href='/wiki/StartWithGAML'>Start with GAML
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/ModelOrganization'>Organization of a model
</a><br/>
<a href='/wiki/BasicProgrammingConceptsInGAML'>Basic programming concepts in GAML
</a><br/>
    </div>
<a href='/wiki/ManipulateBasicSpecies'>Manipulate basic species
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/GlobalSpecies'>The global species
</a><br/>
<a href='/wiki/RegularSpecies'>Regular species
</a><br/>
<a href='/wiki/DefiningActionsAndBehaviors'>Defining actions and behaviors
</a><br/>
<a href='/wiki/InteractionBetweenAgents'>Interaction between agents
</a><br/>
<a href='/wiki/AttachingSkills'>Attaching Skills
</a><br/>
<a href='/wiki/Inheritance'>Inheritance
</a><br/>
    </div>
<a href='/wiki/DefiningAdvancedSpecies'>Defining advanced species
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/GridSpecies'>Grid Species
</a><br/>
<a href='/wiki/GraphSpecies'>Graph Species
</a><br/>
<a href='/wiki/MirrorSpecies'>Mirror species
</a><br/>
<a href='/wiki/MultiLevelArchitecture'>Multi-level architecture
</a><br/>
    </div>
<a href='/wiki/DefiningGUIExperiment'>Defining GUI Experiment
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/DefiningParameters'>Defining Parameters
</a><br/>
<a href='/wiki/DefiningDisplaysGeneralities'>Defining displays (Generalities)
</a><br/>
<a href='/wiki/DefiningCharts'>Defining Charts
</a><br/>
<a href='/wiki/Defining3DDisplays'>Defining 3D Displays
</a><br/>
<a href='/wiki/DefiningMonitorsAndInspectors'>Defining monitors and inspectors
</a><br/>
<a href='/wiki/DefiningExportFiles'>Defining export files
</a><br/>
<a href='/wiki/DefiningUserInteraction'>Defining user interaction
</a><br/>
    </div>
<a href='/wiki/ExploringModels'>Exploring Models
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/RunSeveralSimulations'>Run Several Simulations
</a><br/>
<a href='/wiki/BatchExperiments'>Defining Batch Experiments
</a><br/>
<a href='/wiki/ExplorationMethods'>Exploration Methods
</a><br/>
    </div>
<a href='/wiki/OptimizingModels'>Optimizing Models
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/RuntimeConcepts'>Runtime Concepts
</a><br/>
OptimizingModelsSelection
    </div>
<a href='/wiki/MultiParadigmModeling'>Multi-Paradigm Modeling
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/ControlArchitecture'>Control Architectures
</a><br/>
<a href='/wiki/Equations'>Using Equations
</a><br/>
    </div>
    </div>
<a href='/wiki/Recipes'>Recipes
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/ManipulateOSMDatas'>Manipulate OSM Datas
</a><br/>
<a href='/wiki/Diffusion'>Implementing diffusion
</a><br/>
<a href='/wiki/UsingDatabase'>Using Database Access
</a><br/>
<a href='/wiki/CallingR'>Calling R
</a><br/>
<a href='/wiki/UsingFIPAACL'>Using FIPA ACL
</a><br/>
<a href='/wiki/GamAnalyzer'>Using GAMAnalyzer
</a><br/>
<a href='/wiki/UsingBDI'>Using BDI
</a><br/>
<a href='/wiki/UsingDrivingSkill'>Advanced Driving Skill
</a><br/>
<a href='/wiki/ManipulateDates'>Manipulate Dates
</a><br/>
<a href='/wiki/ManipulateLight'>Implementing light
</a><br/>
<a href='/wiki/Comodel'>Using Comodel
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
â€”Headlessmodefordummies
    </div>
    </div>
    </div>
<a href='/wiki/Tutorials'>Tutorials
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/LuneraysFlu'>Luneray's flu
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/LuneraysFlu_step1'>1. Creation of a first basic disease spreading model
</a><br/>
<a href='/wiki/LuneraysFlu_step2'>2. Definition of monitors and chart outputs
</a><br/>
<a href='/wiki/LuneraysFlu_step3'>3. Importation of GIS data
</a><br/>
<a href='/wiki/LuneraysFlu_step4'>4. Use of a graph to constraint the movements of people]
</a><br/>
<a href='/wiki/LuneraysFlu_step5'>5. Definition of 3D displays
</a><br/>
    </div>
<a href='/wiki/IncrementalModel'>Incremental Model
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/IncrementalModel_step1'>1. Simple SI Model
</a><br/>
<a href='/wiki/IncrementalModel_step2'>2. Charts
</a><br/>
<a href='/wiki/IncrementalModel_step3'>3. Integration of GIS Data
</a><br/>
<a href='/wiki/IncrementalModel_step4'>4. Movement on Graph
</a><br/>
<a href='/wiki/IncrementalModel_step5'>5. Visualizing in 3D
</a><br/>
<a href='/wiki/IncrementalModel_step6'>6. Multi-Level
</a><br/>
<a href='/wiki/IncrementalModel_step7'>7. Differential Equations
</a><br/>
    </div>
<a href='/wiki/PredatorPrey'>Predator Prey
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/PredatorPrey_step1'>1. Basic Model
</a><br/>
<a href='/wiki/PredatorPrey_step2'>2. Vegetation Dynamic
</a><br/>
<a href='/wiki/PredatorPrey_step3'>3. Prey Agent Behavior
</a><br/>
<a href='/wiki/PredatorPrey_step4'>4. Inspectors and Monitors
</a><br/>
<a href='/wiki/PredatorPrey_step5'>5. Predator Agent
</a><br/>
<a href='/wiki/PredatorPrey_step6'>6. Breeding
</a><br/>
<a href='/wiki/PredatorPrey_step7'>7. Agent Aspect
</a><br/>
<a href='/wiki/PredatorPrey_step8'>8. Complex Behavior
</a><br/>
<a href='/wiki/PredatorPrey_step9'>9. Stopping condition
</a><br/>
<a href='/wiki/PredatorPrey_step10'>10. Charts
</a><br/>
<a href='/wiki/PredatorPrey_step11'>11. Writing Files
</a><br/>
<a href='/wiki/PredatorPrey_step12'>12. Image loading
</a><br/>
    </div>
<a href='/wiki/RoadTrafficModel'>Road Traffic
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/RoadTrafficModel_step1'>1. Loading of GIS Data
</a><br/>
<a href='/wiki/RoadTrafficModel_step2'>2. People Agents
</a><br/>
<a href='/wiki/RoadTrafficModel_step3'>3. Movement of People
</a><br/>
<a href='/wiki/RoadTrafficModel_step4'>4. Weight for Road Network
</a><br/>
<a href='/wiki/RoadTrafficModel_step5'>5. Dynamic weights
</a><br/>
<a href='/wiki/RoadTrafficModel_step6'>6. Charts
</a><br/>
<a href='/wiki/RoadTrafficModel_step7'>7. Automatic Road Repair
</a><br/>
    </div>
<a href='/wiki/ThreeD'>3D Tutorial
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/ThreeD_step1'>1. Basic Model
</a><br/>
<a href='/wiki/ThreeD_step2'>2. Moving Cells
</a><br/>
<a href='/wiki/ThreeD_step3'>3. Connections
</a><br/>
    </div>
    </div>
    </div>
<a href='/wiki/References'>References
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/PlatformDocumentation'>Platform
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/InstallationAndLaunching'>Installation and Launching
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/Installation'>Installation
</a><br/>
<a href='/wiki/Launching'>Launching GAMA
</a><br/>
<a href='/wiki/Headless'>Headless Mode
</a><br/>
<a href='/wiki/Updating'>Updating GAMA
</a><br/>
<a href='/wiki/InstallingPlugins'>Installing Plugins
</a><br/>
<a href='/wiki/Troubleshooting'>Troubleshooting
</a><br/>
    </div>
<a href='/wiki/WorkspaceProjectsAndModels'>Workspace, Projects and Models
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/NavigatingWorkspace'>Navigating in the Workspace
</a><br/>
<a href='/wiki/ChangingWorkspace'>Changing Workspace
</a><br/>
<a href='/wiki/ImportingModels'>Importing Models
</a><br/>
    </div>
<a href='/wiki/EditingModels'>Editing models
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/GamlEditorGeneralities'>The GAML Editor - Generalities
</a><br/>
<a href='/wiki/GamlEditorToolbar'>The GAML Editor Toolbar
</a><br/>
<a href='/wiki/ValidationOfModels'>Validation of Models
</a><br/>
    </div>
<a href='/wiki/RunningExperiments'>Running Experiments
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/LaunchingExperiments'>Launching Experiments from the User Interface
</a><br/>
<a href='/wiki/ExperimentsUserInterface'>Experiments User Interface
</a><br/>
<a href='/wiki/MenusAndCommands'>Menus and Commands
</a><br/>
<a href='/wiki/ParametersView'>Parameters View
</a><br/>
<a href='/wiki/InspectorsAndMonitors'>Inspectors and monitors
</a><br/>
<a href='/wiki/Displays'>Displays
</a><br/>
<a href='/wiki/BatchSpecific'>Batch Specific UI
</a><br/>
<a href='/wiki/ErrorsView'>Errors View
</a><br/>
    </div>
<a href='/wiki/Preferences'>Preferences
</a><br/>
    </div>
<a href='/wiki/GamlReferences'>Gaml Reference
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/BuiltInSpecies'>Built-in Species
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/AgentBuiltIn'>The 'agent' built-in species (Under Construction)
</a><br/>
<a href='/wiki/ModelBuiltIn'>The 'model' built-in species (Under Construction)
</a><br/>
<a href='/wiki/ExperimentBuiltIn'>The 'experiment' built-in species (Under Construction)
</a><br/>
    </div>
<a href='/wiki/BuiltInSkills'>Built-in Skills
</a><br/>
<a href='/wiki/BuiltInArchitectures'>Built-in Architectures
</a><br/>
<a href='/wiki/Statements'>Statements
</a><br/>
<a href='/wiki/DataTypes'>Types
</a><br/>
<a href='/wiki/FileTypes'>File Types
</a><br/>
<a href='/wiki/Expressions'>Expressions
</a><br/>
      <div id='sub' class=' w3-padding-small w3-bar-block w3-small'>
<a href='/wiki/Literals'>Literals
</a><br/>
<a href='/wiki/UnitsAndConstants'>Units and constants
</a><br/>
<a href='/wiki/PseudoVariables'>Pseudo-variables
</a><br/>
<a href='/wiki/VariablesAndAttributes'>Variables and Attributes
</a><br/>
<a href='/wiki/Operators'>Operators 
</a><br/>
    </div>
    </div>
    </div>
Community
</div></div></nav></div>
    <div class="w3-threequarter">
        <h1 id="comodel-sir-switch">Comodel SIR Switch</h1>

<p><em>Author : HUYNH Quang Nghi</em></p>

<p>This is a comodel that implement the dynamic of SIR_switch: it will use the EBM when the density of population is big and ABM when the density of population is low. It demonstrate the capability of using dynamically the legacy models.
SIR_ABM_coupling is the coupling that manipulates the elements inside SIR_ABM model and proposes the function would be used from outside. SIR_ABM is a simple example of SIR that use the agents to represent the spreading of disease..
SIR_EBM_coupling is the coupling that manipulates the elements inside SIR_EBM model and proposes the function would be used from outside. SIR_EBM is a simple example of ODE use into agents with the example of the SIR equation system.</p>

<p>Imported models :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>model SIR_ABM 

global{
	geometry shape&lt;-envelope(square(100));
	float beta &lt;- 0.5 ; 	 
	float nu &lt;- 0.001 ;
	float delta &lt;- 0.01;
	init{
		create Host number:495 ;
		create Host number:5{state&lt;-1;}
		
	}
}

species Host skills:[moving]{
	int state&lt;-0;
	list&lt;rgb&gt; color&lt;-[#green, #red, #yellow];
	reflex moving{
		do wander;
	}


    
    reflex become_infected when: state=1 {
    	list n&lt;- self neighbors_at(1);
    	ask n{    		
	    	if (flip(beta)) {
				state&lt;-1;    
	        }
    	}
    }
    
    reflex become_immune when: (state=1 and flip(delta)) {
    	state&lt;-2;
    }
    
            
	aspect base{
		draw circle(1) color: color[state];
	}
}
experiment SIR_ABM_exp type:gui{
	output {
		display gridDisp{
			species Host aspect:base;
		}
	}
}
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>model SIR_ABM_coupling

import "SIR_ABM.gaml"
experiment SIR_ABM_coupling_exp type: gui parent: SIR_ABM_exp
{
	int get_num_S
	{
		return length(Host where (each.state = 0));
	}

	int get_num_I
	{
		return length(Host where (each.state = 1));
	}

	int get_num_R
	{
		return length(Host where (each.state = 2));
	}

	action set_num_S_I_R (int numS, int numI, int numR)
	{
		unknown call;
		call &lt;- set_num_S(numS);
		call &lt;- set_num_I(numI);
		call &lt;- set_num_R(numR);
	}

	action set_num_S (int num)
	{
		ask (Host where (each.state = 0))
		{
			do die;
		}

		create Host number: num
		{
			state &lt;- 0;
		}

	}

	action set_num_I (int num)
	{
		ask (Host where (each.state = 1))
		{
			do die;
		}

		create Host number: num
		{
			state &lt;- 1;
		}

	}

	action set_num_R (int num)
	{
		ask (Host where (each.state = 2))
		{
			do die;
		}

		create Host number: num
		{
			state &lt;- 2;
		}

	}

	output
	{
	}

}
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>model SIR_EBM

global {
	init{
		create agent_with_SIR_dynamic;
	} 
}


species agent_with_SIR_dynamic {
	int N &lt;- 495 ;
	int iInit &lt;- 5;		

    float t;  
	float S &lt;- N - float(iInit); 	      
	float I &lt;- float(iInit); 
	float R &lt;- 0.0; 
	
	float alpha &lt;- 0.2;
	float beta &lt;- 0.8; 

	float h &lt;- 0.01;
   
	equation SIR{ 
		diff(S,t) = (- beta *   S * I / N);
		diff(I,t) = (  beta*  S * I / N) - (alpha * I)  ;
		diff(R,t) = (  alpha  *  I) ;
	}
                
    reflex solving {
//    	write S;
    	solve SIR method: "rk4" step: h;// cycle_length: 1/h ;
    }    
}


experiment SIR_EBM_exp type: gui {
	output { 
		display display_charts {
			chart "SIR_agent" type: series background: #white {
				data 'S' value: first(list(agent_with_SIR_dynamic)).S color: #green ;				
				data 'I' value: first(list(agent_with_SIR_dynamic)).I color: #red ;
				data 'R' value: first(list(agent_with_SIR_dynamic)).R color: #blue ;
			}
		}
	}
}
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>model SIR_EBM_coupling

import "SIR_EBM.gaml"
experiment SIR_EBM_coupling_exp type: gui parent: SIR_EBM_exp
{
	int get_num_S
	{
		return first(agent_with_SIR_dynamic).S;
	}

	int get_num_I
	{
		return first(agent_with_SIR_dynamic).I;
	}

	int get_num_R
	{
		return first(agent_with_SIR_dynamic).R;
	}

	action set_num_S_I_R (int numS, int numI, int numR)
	{
		unknown call;
		call &lt;- set_num_S(numS);
		call &lt;- set_num_I(numI);
		call &lt;- set_num_R(numR);
	}

	action set_num_S (int num)
	{
		first(agent_with_SIR_dynamic).S &lt;- float(num);
	}

	action set_num_I (int num)
	{
		first(agent_with_SIR_dynamic).I &lt;- float(num);
	}

	action set_num_R (int num)
	{
		first(agent_with_SIR_dynamic).R &lt;- float(num);
	}

	output
	{
	}

}
</code></pre>
</div>

<p>Code of the model :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>model Comodel_SIR_Switch

import "Legacy_models/SIR_EBM_coupling.gaml" as SIR_1
import "Legacy_models/SIR_ABM_coupling.gaml" as SIR_2


global
{
	geometry shape &lt;- envelope(square(100));
	int switch_threshold &lt;- 120; // threshold for switching models
	int threshold_to_IBM &lt;- 220; // threshold under which the model swith to IBM
	int threshold_to_Maths &lt;- 20;
	init
	{
		create SIR_1.SIR_EBM_coupling_exp;
		create SIR_2.SIR_ABM_coupling_exp;
		create Switch;
	}

}

species Switch
{
	int S &lt;- 495;
	int I &lt;- 5;
	int R &lt;- 0;
	reflex request_from_micro_model
	{
		//if the size of S population and I population are bigger than a threshold, use the EBM
		if (S &gt; threshold_to_Maths and I &gt; threshold_to_Maths)
		{
			ask world
			{
				unknown call;
				call &lt;- first(SIR_1.SIR_EBM_coupling_exp).set_num_S_I_R(myself.S, myself.I, myself.R);
				ask first(SIR_1.SIR_EBM_coupling_exp).simulation
				{
					loop times: 5
					{
						do _step_;
					}

				}

				myself.S &lt;- first(SIR_1.SIR_EBM_coupling_exp).get_num_S();
				myself.I &lt;- first(SIR_1.SIR_EBM_coupling_exp).get_num_I();
				myself.R &lt;- first(SIR_1.SIR_EBM_coupling_exp).get_num_R();
			}

		}
		
		//if the size of S population or  I population are smaller  than a threshold, use the ABM
		if (I &lt; threshold_to_IBM or S &lt; threshold_to_IBM)
		{
			ask world
			{
				unknown call;
				call &lt;- first(SIR_2.SIR_ABM_coupling_exp).set_num_S_I_R(myself.S, myself.I, myself.R);
				ask first(SIR_2.SIR_ABM_coupling_exp).simulation
				{
					loop times: 1
					{
						do _step_;
					}

				}

				myself.S &lt;- first(SIR_2.SIR_ABM_coupling_exp).get_num_S();
				myself.I &lt;- first(SIR_2.SIR_ABM_coupling_exp).get_num_I();
				myself.R &lt;- first(SIR_2.SIR_ABM_coupling_exp).get_num_R();
			}

		}

	}

	aspect base
	{
		draw square(100);
	}

}

experiment Simple_exp type: gui
{
	output
	{
		display co_SIR_chart
		{
			chart "SIR_agent" type: series background: # white
			{
				data 'S' value: first(Switch).S color: # green;
				data 'I' value: first(Switch).I color: # red;
				data 'R' value: first(Switch).R color: # yellow;
			}

		}

	}

}
</code></pre>
</div>

    </div>
    </div>
    </div>
    </body></html>
